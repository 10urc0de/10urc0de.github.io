---
layout: post
date: 2024-12-09
title: "CVE-2019-14776(VLC Media Player) 분석"
tags: [pwnable, VLC, AFL++, ]
categories: [1-day, open-source, ]
---

## 개요

---

VLC Media Player : 크로스 플랫폼 오픈소스 미디어 플레이어

CVE-2019-14776 : 3.0.7.1, `demux/asf/asf.c`의 `DemuxInit` 함수에서 발생하는 `heap-based buffer over-read` 취약점

## AFL - 부분 계측

---

퍼저에서 자체적으로 실행 경로를 찾는 것은 단점이 될 수도 있다.

예를 들어 퍼저에 유효한 MKV 파일을 제공했다고 가정해보자.

만약 퍼저가 파일의 매직넘버를 변경하여 테스트케이스가 AVI 파일로 변경된다면 이 파일은 AVI Demux에서 처리된다.

이후에 퍼저가 다시 매직넘버를 변경하여 MPEG 파일로 변경되어 MPEG Demux에서 처리된다.

두 경우 모두 변경된 파일이 유효한 구문 구조를 갖지 않기 때문에 커버리지의 깊이를 증가시키기 힘들다.

따라서 커버리지 적용 범위에 제약을 두지 않으면 퍼저가 잘못된 경로를 탐색하여 퍼징의 효율성을 떨어뜨리게 된다.

이러한 문제를 해결하기 위해서 부분 계측을 사용하며, 퍼저가 중요한 부분에 집중할 수 있게 도움이 된다.

부분 계측은 `AFL_LLVM_ALLOWLIST` 환경 변수를 이용하거나, 소스코드 안에서 매크로를 이용하여 사용할 수 있다.

### 매크로

---

예시

```bash
#include <stdio.h>
#include <stdint.h>
// ...

__AFL_COVERAGE();  // <- required for this feature to work
```

- `__AFL_COVERAGE_ON();`
    - 해당 시점부터 커버리지 활성화
- `__AFL_COVERAGE_OFF();`
    - 해당 시점부터 커버리지 비활성화
- `__AFL_COVERAGE_DISCARD();`
    - 현재까지 모은 커버리지를 모두 초기화
- `__AFL_COVERAGE_SKIP();`
    - 해당 테스트 사례를 중요하지 않은 것으로 표시
        
        무슨 일이 있어도 afl-fuzz는 이를 무시한다
        

### 환경 변수

---

계측을 삽입할 파일/함수들을 작성한 파일을 빌드시에 `AFL_LLVM_ALLOWLIST`/`AFL_LLVM_DENYLIST`의 값으로 전달하면 된다.

예시

```bash
src: project/ # 소스코드 계측 활성화
src: project/feature_a/a1.cpp
src: project/feature_a/a2.cpp
src: project/feature_b/b1.cpp
src: project/feature_b/b2.cpp

fun: MallocFoo # 함수 계측 활성화
```

## 사전 준비

---

### 빌드

---

 Fuzzing 101에 나온 방법으로는 오류가 발생하므로, 다음과 같이 빌드해야 한다.

```bash
apt-get update
apt-get build-dep vlc
```

`build-dep` 실행 중 오류 발생 시 :

`/etc/apt/source.list` 에서 `deb-src`의 주석을 모두 해제 후 재실행


```bash
apt-get update
apt-get build-dep vlc
```

make 실행 중 오류 발생시 :

본인은 aflplusplus 도커 컨테이너에서 진행 중에 오류가 발생하여 VM에서 진행하였다.



### Harness 작성

---

먼저 취약점이 발생한 `DemuxInit` 함수에 대해 살펴보자.

Demux는 demultiplexing의 약자로 다중 부분 스트림을 읽고 각 부분을 별도의 스트림으로 저장하는 과정이다.

예를 들어 AVI 파일의 경우 오디오와 비디오로 구성된다. 이는 스피커와 모니터에 각각 도달할 수 있도록 디먹싱 과정을 통해 분리되게 된다.

VLC에서는 디먹서로 ASF, ogg, mkv를 사용한다.

여기서 ASF(Advanced Streaming Format)는 스트리밍 미디어를 위한 Microsoft의 독점 디지털 오디오/디지털 비디오를 담는 형식이다.

해당 함수는 ASF를 위한 디먹서를 초기화하는 함수임을 알 수 있다.

또한 VLC에서는 퍼저를 위한 코드를 제공해주고 있다.

코드의 커밋 메세지는 다음과 같다.

```
This includes support for statically linked plugins. It vastly increases
the test iteration speed, which is critical for fuzz testing.
Furthermore, it is necessary for coverage-driven fuzz testing to work at
all.

이 기능은 정적으로 연결된 플러그인에 대한 지원을 포함합니다. 이는 테스트의 반복 속도를 대폭 상승시키며,
퍼징에 매우 중요합니다. 뿐만 아니라 커버리지 기반 퍼징을 작동하는데에 필수적입니다.

.. 중략

2) American Fuzzy Lop run:
  - Make a *static* build with AFL as the toolchain.
  - (Where applicable) perform adequate religious luck granting
    offerings or other rites.
  - Run AFL with test/vlc-demux-run as the fuzzed executable.

2) American Fuzzy Lop 실행:
	- AFL를 툴체인으로 사용하여 정적 빌드 생성
	- (해당되는 경우) ...
	- test/vlc-demux-run을 타겟 실행파일로 AFL 실행
```

따라서 해당 소스코드에 harness를 작성하였다.

해당 소스코드의 원본은 다음과 같다.

```c
/**
 * @file vlc-demux-test.c
 */
/*****************************************************************************
 * Copyright © 2016 Rémi Denis-Courmont
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * Rémi Denis-Courmont reserves the right to redistribute this file under
 * the terms of the GNU Lesser General Public License as published by the
 * the Free Software Foundation; either version 2.1 or the License, or
 * (at his option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston MA 02110-1301, USA.
 *****************************************************************************/

#ifdef HAVE_CONFIG_H
# include "config.h"
#endif

#include <stdio.h>
#include "src/input/demux-run.h"

int main(int argc, char *argv[])
{
    const char *filename;
    struct vlc_run_args args;
    vlc_run_args_init(&args);

    switch (argc)
    {
        case 2:
            filename = argv[argc - 1];
            break;
        default:
            fprintf(stderr, "Usage: [VLC_TARGET=demux] %s <filename>\n", argv[0]);
            return 1;
    }

    return -vlc_demux_process_path(&args, filename);
}
```

명령줄 인자로 받은 파일명을 인자로  `vlc_demux_process_path` 함수를 호출한다.

```c
#include "common.h"

int vlc_demux_process_url(const struct vlc_run_args *, const char *url);
int vlc_demux_process_path(const struct vlc_run_args *, const char *path);
int vlc_demux_process_memory(const struct vlc_run_args *,
                             const unsigned char *buf, size_t length);
```

`src/input/demux-run.h`에는 `vlc_demux_process_memory` 함수도 포함되어 있으므로, 퍼징 속도를 향상시키기 위해 공유메모리를 사용하도록 하여 vlc에 값을 전달하였다.

다음과 같이 하네스를 작성하였다.

```c
#ifdef HAVE_CONFIG_H
#include "config.h"
#endif

#include <stdio.h>
#include "src/input/demux-run.h"

#ifdef __AFL_COMPILER
__AFL_FUZZ_INIT();
#endif

// 바로 이곳으로 들어오므로 지연된 초기화가 필요하지 않다.
int main(int argc, char *argv[])
{
    const char *filename;
    struct vlc_run_args args;
    vlc_run_args_init(&args);

    // switch (argc)
    // {
    //     case 2:
    //         filename = argv[argc - 1];
    //         break;
    //     default:
    //         fprintf(stderr, "Usage: [VLC_TARGET=demux] %s <filename>\n", argv[0]);
    //         return 1;
    // }

#ifdef __AFL_COMPILER
    unsigned char *buf;
    size_t len;

    while (__AFL_LOOP(1000))
    {
        buf = __AFL_FUZZ_TESTCASE_BUF;
        len = __AFL_FUZZ_TESTCASE_LEN;
        vlc_demux_process_memory(&args, buf, len);
    }
#endif

    return 0;
}
```

### 부분 계측 함수&파일 지정

---

ASF 디먹싱과 관련된 함수, 파일만을 허용하도록 작성하였다.

```
demux/asf/asf.c
demux/asf/asfpacket.c
demux/asf/libasf.c
vlc.c

#fun: Demux
fun: WaitKeyframe
fun: SeekPercent
fun: SeekIndex
fun: SeekPrepare
#fun: Control
fun: Packet_SetAR
fun: Packet_SetSendTime
fun: Packet_UpdateTime
fun: Packet_GetTrackInfo
fun: Packet_DoSkip
fun: Packet_Enqueue
fun: Block_Dequeue
fun: ASF_fillup_es_priorities_ex
fun: ASF_fillup_es_bitrate_priorities_ex
fun: DemuxInit
fun: FlushQueue
fun: FlushQueues
fun: DemuxEnd

fun: AsfObjectHelperHave
fun: AsfObjectHelperSkip
fun: AsfObjectHelperReadString
fun: ASF_ReadObjectCommon
fun: ASF_NextObject
fun: ASF_FreeObject_Null
fun: ASF_ReadObject_Header
fun: ASF_ReadObject_Data
fun: ASF_ReadObject_Index
fun: ASF_FreeObject_Index
fun: ASF_ReadObject_file_properties
fun: ASF_FreeObject_metadata
fun: ASF_ReadObject_metadata
fun: ASF_ReadObject_header_extension
fun: ASF_FreeObject_header_extension
fun: ASF_ReadObject_stream_properties
fun: ASF_FreeObject_stream_properties
fun: ASF_FreeObject_codec_list
fun: ASF_ReadObject_codec_list
fun: ASF_ReadObject_content_description
fun: ASF_FreeObject_content_description
fun: ASF_ReadObject_language_list
fun: ASF_FreeObject_language_list
fun: ASF_ReadObject_stream_bitrate_properties
fun: ASF_FreeObject_stream_bitrate_properties
fun: ASF_FreeObject_extended_stream_properties
fun: ASF_ReadObject_extended_stream_properties
fun: ASF_ReadObject_advanced_mutual_exclusion
fun: ASF_FreeObject_advanced_mutual_exclusion
fun: ASF_ReadObject_stream_prioritization
fun: ASF_FreeObject_stream_prioritization
fun: ASF_ReadObject_bitrate_mutual_exclusion
fun: ASF_FreeObject_bitrate_mutual_exclusion
fun: ASF_FreeObject_extended_content_description
fun: ASF_ReadObject_marker
fun: ASF_FreeObject_marker
fun: ASF_ReadObject_Raw
fun: ASF_ParentObject
fun: ASF_GetObject_Function
fun: ASF_ReadObject
fun: ASF_FreeObject
fun: ASF_ObjectDumpDebug
fun: ASF_ReadObjectRoot
fun: ASF_FreeObjectRoot
fun: ASF_CountObject
fun: ASF_FindObject

fun: DemuxSubPayload
fun: ParsePayloadExtensions
fun: DemuxPayload
fun: DemuxASFPacket
```

### AFL 실행

---

- 타겟 컴파일

```bash
CC="afl-clang-fast" CXX="afl-clang-fast++" ./configure --prefix=/home/vlc/install --disable-a52 --disable-lua --disable-qt --with-sanitizer=address
```

```bash
AFL_LLVM_ALLOWLIST=/home/vlc/partial_instrumentation make -j$(nproc) LDFLAGS="-fsanitize=address"
```

```bash
cd test
make vlc-demux-run -j$(nproc) LDFLAGS="-fsanitize=address"
```

- AFL 실행

```bash
afl-fuzz -t 100 -m none -i './afl_in' -o './afl_out' -x asf_dictionary.dict -D -M master -- ./test/vlc-demux-run @@
```